# ğŸ¬ ì‹¤ì‹œê°„ ëŒ“ê¸€ ì˜¤ë²„ë ˆì´ ì‹œìŠ¤í…œ (Danmaku Live Stream)

> ë‹ˆì½”ë‹ˆì½” ë™í™”ì™€ í‹°ë¹„í”Œ ìŠ¤íƒ€ì¼ì˜ ì‹¤ì‹œê°„ ëŒ“ê¸€(å¼¾å¹•/Danmaku) ì‹œìŠ¤í…œ

## ğŸ“Œ í”„ë¡œì íŠ¸ ê°œìš”

### í•µì‹¬ ëª©í‘œ
- **ê°„ë‹¨í•˜ê³  ì‹¤ìš©ì ì¸** ì‹¤ì‹œê°„ ëŒ“ê¸€ ì˜¤ë²„ë ˆì´ ì‹œìŠ¤í…œ
- **ìµœì†Œí•œì˜ ê¸°ìˆ  ìŠ¤íƒ**ìœ¼ë¡œ ìµœëŒ€ íš¨ê³¼
- **ì‹¤ì œ êµ¬í˜„ ê°€ëŠ¥í•œ** MVP ìˆ˜ì¤€ì˜ ì„¤ê³„

### ì£¼ìš” ê¸°ëŠ¥
1. **ì‹¤ì‹œê°„ ìŠ¤íŠ¸ë¦¬ë°**: RTMP/WebRTC ê¸°ë°˜ ë¹„ë””ì˜¤ ìŠ¤íŠ¸ë¦¬ë°
2. **Danmaku ëŒ“ê¸€**: í™”ë©´ì„ ê°€ë¡œì§€ë¥´ëŠ” ìœ ë™ ëŒ“ê¸€
3. **ëŒ“ê¸€ ëª…ë ¹ì–´**: ìƒ‰ìƒ, í¬ê¸°, ìœ„ì¹˜ ì œì–´ (ë‹ˆì½”ë‹ˆì½” ìŠ¤íƒ€ì¼)
4. **ê°„ë‹¨í•œ ëª¨ë”ë ˆì´ì…˜**: ê¸ˆì¹™ì–´ í•„í„°, ì‹ ê³  ê¸°ëŠ¥
5. **ê¸°ë³¸ í†µê³„**: ì‹œì²­ì ìˆ˜, ëŒ“ê¸€ ìˆ˜

### ì°¸ê³  í”„ë¡œì íŠ¸
- [DPlayer](https://github.com/DIYgod/DPlayer) - 16kâ­ HTML5 danmaku ë¹„ë””ì˜¤ í”Œë ˆì´ì–´
- [niconico-twitch](https://github.com/tekigg/niconico-twitch) - ë‹ˆì½”ë‹ˆì½” ìŠ¤íƒ€ì¼ Twitch ì˜¤ë²„ë ˆì´
- [DanMage](https://danmage.com/) - ë¸Œë¼ìš°ì € í™•ì¥ danmaku ì‹œìŠ¤í…œ

---

## ğŸ—ï¸ ì‹œìŠ¤í…œ ì•„í‚¤í…ì²˜

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Frontend (React)                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚Video Player â”‚  â”‚Comment Canvasâ”‚  â”‚   Chat UI    â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚ WebSocket
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Backend (NestJS)                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  API Routes â”‚  â”‚WebSocket Hub â”‚  â”‚Stream Serviceâ”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                                  â”‚
   â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”                    â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
   â”‚PostgreSQLâ”‚                    â”‚    Redis    â”‚
   â”‚(Main DB) â”‚                    â”‚   (Cache)   â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ’» Frontend (React + TypeScript)

### ê¸°ìˆ  ìŠ¤íƒ
- **Framework**: React 18 + TypeScript
- **Build Tool**: Vite (ë¹ ë¥¸ ê°œë°œ í™˜ê²½)
- **State**: Zustand (ê°„ë‹¨í•œ ìƒíƒœ ê´€ë¦¬)
- **API**: React Query (ì„œë²„ ìƒíƒœ ê´€ë¦¬)
- **Style**: Tailwind CSS (ìœ í‹¸ë¦¬í‹° CSS)
- **Canvas**: HTML5 Canvas API (ëŒ“ê¸€ ë Œë”ë§)

### í•µì‹¬ ì»´í¬ë„ŒíŠ¸

#### 1. VideoPlayer
```typescript
// ê°„ë‹¨í•œ ë¹„ë””ì˜¤ í”Œë ˆì´ì–´ ë˜í¼
interface VideoPlayerProps {
  streamUrl: string;
  onTimeUpdate: (time: number) => void;
}

// HLS.js ë˜ëŠ” ë„¤ì´í‹°ë¸Œ video íƒœê·¸ ì‚¬ìš©
```

#### 2. DanmakuCanvas (ëŒ“ê¸€ ë Œë”ë§)
```typescript
interface DanmakuComment {
  id: string;
  text: string;
  x: number;
  y: number;
  color: string;
  size: 'small' | 'medium' | 'big';
  type: 'scroll' | 'top' | 'bottom';
  speed: number;
}

// Canvas 2D Contextë¡œ ëŒ“ê¸€ ë Œë”ë§
// requestAnimationFrameìœ¼ë¡œ 60fps ì• ë‹ˆë©”ì´ì…˜
```

#### 3. CommentInput
```typescript
// ë‹ˆì½”ë‹ˆì½” ìŠ¤íƒ€ì¼ ëª…ë ¹ì–´ íŒŒì‹±
// "ue red big" â†’ {position: 'top', color: 'red', size: 'big'}
```

### ë””ë ‰í† ë¦¬ êµ¬ì¡° (ê°„ì†Œí™”)
```
frontend/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ components/
â”‚   â”‚   â”œâ”€â”€ VideoPlayer.tsx
â”‚   â”‚   â”œâ”€â”€ DanmakuCanvas.tsx
â”‚   â”‚   â”œâ”€â”€ CommentInput.tsx
â”‚   â”‚   â””â”€â”€ ViewerList.tsx
â”‚   â”œâ”€â”€ hooks/
â”‚   â”‚   â”œâ”€â”€ useWebSocket.ts
â”‚   â”‚   â”œâ”€â”€ useDanmaku.ts
â”‚   â”‚   â””â”€â”€ useStream.ts
â”‚   â”œâ”€â”€ stores/
â”‚   â”‚   â””â”€â”€ streamStore.ts
â”‚   â”œâ”€â”€ utils/
â”‚   â”‚   â”œâ”€â”€ danmakuParser.ts
â”‚   â”‚   â””â”€â”€ commentCommands.ts
â”‚   â””â”€â”€ App.tsx
```

---

## ğŸš€ Backend (NestJS)

### ê¸°ìˆ  ìŠ¤íƒ
- **Framework**: NestJS (êµ¬ì¡°í™”ëœ Node.js)
- **WebSocket**: Socket.io (ì‹¤ì‹œê°„ í†µì‹ )
- **Database**: PostgreSQL (ë©”ì¸ ë°ì´í„°)
- **Cache**: Redis (ì„¸ì…˜, ì‹¤ì‹œê°„ ë°ì´í„°)
- **ORM**: TypeORM (ë°ì´í„°ë² ì´ìŠ¤ ì¶”ìƒí™”)

### í•µì‹¬ ëª¨ë“ˆ

#### 1. Stream Module
```typescript
// ìŠ¤íŠ¸ë¦¼ ìƒì„±, ê´€ë¦¬
@Controller('streams')
export class StreamController {
  @Post()
  createStream(dto: CreateStreamDto) {}
  
  @Get(':id')
  getStream(id: string) {}
  
  @Post(':id/start')
  startStream(id: string) {}
}
```

#### 2. Comment Module
```typescript
// ëŒ“ê¸€ ì²˜ë¦¬ ë° ë¸Œë¡œë“œìºìŠ¤íŒ…
@WebSocketGateway()
export class CommentGateway {
  @SubscribeMessage('comment')
  handleComment(client: Socket, data: CommentDto) {
    // 1. ìœ íš¨ì„± ê²€ì¦
    // 2. ë ˆì¸ í• ë‹¹
    // 3. ë¸Œë¡œë“œìºìŠ¤íŠ¸
  }
}
```

#### 3. Lane Manager (ì¶©ëŒ ë°©ì§€)
```typescript
// ëŒ“ê¸€ì´ ê²¹ì¹˜ì§€ ì•Šë„ë¡ ë ˆì¸ ê´€ë¦¬
class LaneManager {
  assignLane(comment: Comment): number {
    // ë¹ˆ ë ˆì¸ ì°¾ê¸°
    // ì¶©ëŒ ê²€ì‚¬
    return laneNumber;
  }
}
```

### ë””ë ‰í† ë¦¬ êµ¬ì¡° (ê°„ì†Œí™”)
```
backend/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ modules/
â”‚   â”‚   â”œâ”€â”€ stream/
â”‚   â”‚   â”œâ”€â”€ comment/
â”‚   â”‚   â””â”€â”€ user/
â”‚   â”œâ”€â”€ common/
â”‚   â”‚   â”œâ”€â”€ guards/
â”‚   â”‚   â””â”€â”€ filters/
â”‚   â””â”€â”€ main.ts
```

---

## ğŸ—„ï¸ Database Schema (PostgreSQL + Redis)

### PostgreSQL Tables

#### users (ì‚¬ìš©ì)
```sql
CREATE TABLE users (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  username VARCHAR(50) UNIQUE NOT NULL,
  email VARCHAR(255) UNIQUE NOT NULL,
  password_hash VARCHAR(255) NOT NULL,
  level INTEGER DEFAULT 1,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### streams (ë°©ì†¡)
```sql
CREATE TABLE streams (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  owner_id UUID REFERENCES users(id),
  title VARCHAR(255) NOT NULL,
  status VARCHAR(20) DEFAULT 'waiting',
  viewer_count INTEGER DEFAULT 0,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### comments (ëŒ“ê¸€ - ë³´ê´€ìš©)
```sql
CREATE TABLE comments (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  stream_id UUID REFERENCES streams(id),
  user_id UUID REFERENCES users(id),
  text VARCHAR(200) NOT NULL,
  command VARCHAR(50),
  vpos INTEGER, -- ë¹„ë””ì˜¤ ìœ„ì¹˜
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- ì¸ë±ìŠ¤
CREATE INDEX idx_comments_stream ON comments(stream_id, created_at);
```

### Redis Structure

```redis
# ì‹¤ì‹œê°„ ëŒ“ê¸€ í
stream:{streamId}:comments -> List
  ["comment1_json", "comment2_json", ...]

# í™œì„± ì‹œì²­ì
stream:{streamId}:viewers -> Set
  ["userId1", "userId2", ...]

# ëŒ“ê¸€ ë ˆì¸ ìƒíƒœ
stream:{streamId}:lanes -> Hash
  { "0": "occupiedUntil", "1": "occupiedUntil" }

# Rate Limiting
rate:comment:{userId} -> String (counter)
  TTL: 60 seconds
```

---

## ğŸ“¡ WebSocket Protocol

### ì´ë²¤íŠ¸ ì •ì˜

#### Client â†’ Server
```typescript
// ë°© ì…ì¥
socket.emit('join', { streamId, userId })

// ëŒ“ê¸€ ì „ì†¡
socket.emit('comment', {
  text: "ì•ˆë…•í•˜ì„¸ìš”",
  command: "ue red big"  // ë‹ˆì½”ë‹ˆì½” ëª…ë ¹ì–´
})

// í•˜íŠ¸ë¹„íŠ¸
socket.emit('ping')
```

#### Server â†’ Client
```typescript
// ìƒˆ ëŒ“ê¸€
socket.on('new_comment', {
  id: "comment_id",
  text: "ì•ˆë…•í•˜ì„¸ìš”",
  style: { color: "red", size: "big", position: "top" },
  x: 1280,
  y: 100,
  lane: 3
})

// ì‹œì²­ì ìˆ˜ ì—…ë°ì´íŠ¸
socket.on('viewer_count', { count: 152 })
```

---

## ğŸ® ëŒ“ê¸€ ëª…ë ¹ì–´ (ë‹ˆì½”ë‹ˆì½” ìŠ¤íƒ€ì¼)

### ìœ„ì¹˜ ëª…ë ¹ì–´
- `ue` / `top` - ìƒë‹¨ ê³ ì •
- `shita` / `bottom` - í•˜ë‹¨ ê³ ì •
- `naka` - ì¤‘ì•™ (ê¸°ë³¸ê°’: ìœ ë™)

### í¬ê¸° ëª…ë ¹ì–´
- `small` - ì‘ì€ í¬ê¸°
- `medium` - ì¤‘ê°„ (ê¸°ë³¸ê°’)
- `big` - í° í¬ê¸°

### ìƒ‰ìƒ ëª…ë ¹ì–´
- `white`, `red`, `pink`, `orange`, `yellow`
- `green`, `cyan`, `blue`, `purple`, `black`

### ì‚¬ìš© ì˜ˆì‹œ
```
"ue red big" â†’ ìƒë‹¨ ê³ ì •, ë¹¨ê°„ìƒ‰, í° í¬ê¸°
"shita green" â†’ í•˜ë‹¨ ê³ ì •, ì´ˆë¡ìƒ‰, ì¤‘ê°„ í¬ê¸°
"big" â†’ ìœ ë™, í°ìƒ‰, í° í¬ê¸°
```

---

## ğŸš¦ ì„±ëŠ¥ ìµœì í™”

### Frontend
1. **Canvas ìµœì í™”**
   - í™”ë©´ ë°– ëŒ“ê¸€ ì œê±°
   - requestAnimationFrame ì‚¬ìš©
   - ëŒ“ê¸€ ê°œìˆ˜ ì œí•œ (í™”ë©´ë‹¹ ìµœëŒ€ 50ê°œ)

2. **ë©”ëª¨ë¦¬ ê´€ë¦¬**
   - ëŒ“ê¸€ ê°ì²´ ì¬ì‚¬ìš©
   - 5ë¶„ ì´ìƒ ì§€ë‚œ ëŒ“ê¸€ ìë™ ì‚­ì œ

### Backend
1. **ìºì‹± ì „ëµ**
   - Redisë¡œ ì‹¤ì‹œê°„ ë°ì´í„° ì²˜ë¦¬
   - PostgreSQLì€ ì˜êµ¬ ì €ì¥ìš©

2. **Rate Limiting**
   - ì‚¬ìš©ìë‹¹ ë¶„ë‹¹ 30ê°œ ëŒ“ê¸€ ì œí•œ
   - IPë‹¹ ë¶„ë‹¹ 100ê°œ ìš”ì²­ ì œí•œ

---

## ğŸ› ï¸ ê°œë°œ í™˜ê²½ ì„¤ì •

### Frontend
```bash
cd frontend
npm install
npm run dev  # Vite ê°œë°œ ì„œë²„
```

### Backend
```bash
cd backend
npm install
npm run start:dev  # NestJS ê°œë°œ ì„œë²„
```

### Docker Compose (ê°œë°œìš©)
```yaml
version: '3.8'
services:
  postgres:
    image: postgres:15
    environment:
      POSTGRES_DB: danmaku
      POSTGRES_PASSWORD: password
    ports:
      - "5432:5432"
  
  redis:
    image: redis:7
    ports:
      - "6379:6379"
```

---

## ğŸ“Š ì˜ˆìƒ ì„±ëŠ¥

### ëª©í‘œ ì§€í‘œ
- **ë™ì‹œ ì‹œì²­ì**: 500ëª…
- **ì´ˆë‹¹ ëŒ“ê¸€**: 100ê°œ
- **ëŒ“ê¸€ ì§€ì—°**: < 100ms
- **ë©”ëª¨ë¦¬ ì‚¬ìš©**: < 500MB

### ì œí•œ ì‚¬í•­
- ë‹¨ì¼ ì„œë²„ ê¸°ì¤€
- ë³µì¡í•œ ì´í™íŠ¸ ì—†ìŒ
- ê¸°ë³¸ ëª¨ë”ë ˆì´ì…˜ë§Œ ì§€ì›

---

## ğŸš€ í–¥í›„ í™•ì¥ ê°€ëŠ¥ì„±

### Phase 1 (í˜„ì¬)
- âœ… ê¸°ë³¸ ìŠ¤íŠ¸ë¦¬ë°
- âœ… Danmaku ëŒ“ê¸€
- âœ… ê°„ë‹¨í•œ ëª…ë ¹ì–´

### Phase 2 (ì¶”ê°€ ê°€ëŠ¥)
- [ ] ëª¨ë°”ì¼ ì§€ì›
- [ ] ì´ëª¨í‹°ì½˜/ìŠ¤í‹°ì»¤
- [ ] ì‚¬ìš©ì ë ˆë²¨ ì‹œìŠ¤í…œ

### Phase 3 (ì¥ê¸°)
- [ ] í´ë¦½ ìƒì„±
- [ ] ë‹¤ì‹œë³´ê¸°
- [ ] ìˆ˜ìµí™” ê¸°ëŠ¥

---

## ğŸ“š ì°¸ê³  ìë£Œ

- [DPlayer Documentation](https://github.com/DIYgod/DPlayer)
- [ë‹ˆì½”ë‹ˆì½” ë™í™” API](https://site.nicovideo.jp/search-api-docs/search.html)
- [Canvas API MDN](https://developer.mozilla.org/en-US/docs/Web/API/Canvas_API)
- [NestJS Documentation](https://docs.nestjs.com/)

---

ì´ ì„¤ê³„ëŠ” **ì‹¤ì œ êµ¬í˜„ ê°€ëŠ¥í•œ MVP** ìˆ˜ì¤€ìœ¼ë¡œ, ë³µì¡í•œ ê¸°ëŠ¥ ì—†ì´ í•µì‹¬ ê¸°ëŠ¥ì—ë§Œ ì§‘ì¤‘í–ˆìŠµë‹ˆë‹¤.